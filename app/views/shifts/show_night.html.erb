<h2><%= @shift.shift_date.strftime("%Y-%m-%d") %></h2>
<h4>勤務スタッフ：<%= @shift.shift_details.count %>名</h4>

<div class="table-wrapper">
  <table class="table table-bordered table-hover text-center shift-table night-shift-table"
         data-controller="shift-detail"
         data-shift-detail-shift-type="night"
         data-shift-detail-break-rooms="<%= @break_rooms.map { |br| {id: br.id, color: br.color} }.to_json %>">

    <thead>
      <tr>
        <th class="bg-secondary text-white">スタッフ</th>
        <th class="bg-secondary text-white">休憩室NG</th>
        <th class="bg-secondary text-white">休憩場所</th>
        <th class="bg-secondary text-white comment-cell">コメント</th>
        <th class="bg-secondary text-white">開始時間</th>

        <!-- ★ 時間軸（22〜8） -->
        <% (22..32).each do |h| %>
          <th class="bg-secondary text-white time-col"><%= "%02d:00" % (h % 24) %></th>
        <% end %>
      </tr>
    </thead>

    <tbody>
      <% grouped = @shift.shift_details.includes(:staff, :break_room)
                          .group_by(&:group)
                          .sort_by { |group, _| [group.nil? ? 1 : 0, group&.created_at] } %>

      <% grouped.each do |group_id, details| %>
        <!-- グループ名 -->
        <tr class="group-row">
          <td colspan="20"><%= Group.find_by(id: group_id)&.name || "未所属" %></td>
        </tr>

        <% details.each do |detail| %>
          <% # ====== 時刻補正の共通処理 ====== %>
          <% rest_s = detail.rest_start_time %>
          <% rest_e = detail.rest_end_time %>

          <% base = @shift.shift_date %>

          <% # start_time 補正（翌日扱いなら +1日） %>
          <% rest_s_fix =
               Time.zone.local(base.year, base.month, base.day, rest_s.hour) +
               (rest_s.to_date > base ? 1.day : 0) %>

          <% # end_time 補正（翌日扱いなら +1日） %>
          <% rest_e_fix =
               Time.zone.local(base.year, base.month, base.day, rest_e.hour) +
               (rest_e.to_date > base ? 1.day : 0) %>

          <% # ==== 内部時間（22〜32）に変換 ==== %>
          <% start_h_display =
              rest_s_fix.hour + (rest_s_fix.to_date > base ? 24 : 0) %>

          <% end_h_display =
              rest_e_fix.hour + (rest_e_fix.to_date > base ? 24 : 0) %>

          <tr data-shift-detail-id="<%= detail.id %>"
              data-break-room-color="<%= detail.break_room&.color %>"
              data-rest-start="<%= start_h_display %>"
              data-rest-end="<%= end_h_display %>"
          >

            <!-- スタッフ名 -->
            <td class="text-start"><%= detail.staff.name %></td>

            <!-- 休憩室NG -->
            <td class="ng-room-col">
              <div class="ng-room-cell">
                <% if detail.staff.ng_break_rooms.any? %>
                  <% detail.staff.ng_break_rooms.each do |room| %>
                    <span class="ng-room-badge"><%= room.name %></span>
                  <% end %>
                <% else %>
                  <span class="text-muted small">-</span>
                <% end %>
              </div>
            </td>

            <!-- 休憩場所 -->
            <td>
              <select name="break_room_id"
                      class="form-select form-select-sm fw-semibold border-success-subtle px-2 py-1"
                      data-action="change->shift-detail#update"
                      data-shift-detail-id="<%= detail.id %>"
                      data-field="break_room_id">
                <% @break_rooms.each do |br| %>
                  <option value="<%= br.id %>"
                          <%= "selected" if br.id == detail.break_room_id %>
                          style="color:<%= br.color %>;">
                    <%= br.name %>
                  </option>
                <% end %>
              </select>
            </td>

            <!-- コメント -->
            <td>
              <%= text_field_tag "comment",
                    detail.comment,
                    maxlength: 15,
                    class: "form-control form-control-sm",
                    data: { action: "blur->shift-detail#update",
                            shift_detail_id: detail.id,
                            field: "comment" } %>
            </td>

            <!-- 開始時間 select -->
            <td>
              <% # rest_start_time の「表示上の時刻（22〜32）」に変換 %>
              <% start_h_display =
                   rest_s_fix.hour + (rest_s_fix.to_date > base ? 24 : 0) %>

              <%= select_tag "rest_start_time",
                    options_for_select(
                      (22..31).map { |h| ["%02d:00" % (h % 24), "%02d:00" % (h % 24)] },
                      "%02d:00" % (start_h_display % 24)
                    ),
                    class: "form-select form-select-sm text-primary fw-semibold border-primary-subtle px-2 py-1",
                    data: { action: "change->shift-detail#update",
                            shift_detail_id: detail.id,
                            field: "rest_start_time" } %>

              <%= hidden_field_tag "group_id",
                  detail.group_id,
                  data: { shift_detail_id: detail.id, field: "group_id" } %>
            </td>

            <!-- ★ 時間軸セル（22〜32） -->
            <% (22..32).each do |h| %>
              <% 
                hour = h % 24
                day  = h >= 24 ? base + 1.day : base

                current_time = Time.zone.local(day.year, day.month, day.day, hour)

                active = (rest_s_fix...rest_e_fix).cover?(current_time)
                room_color = detail.break_room&.color || "#4A90E2"
              %>

              <td class="time-cell"
                  data-hour="<%= h %>"
                  style="<%= active ? "background-color: #{room_color};" : "" %>">
              </td>
            <% end %>

          </tr>
        <% end %>
      <% end %>
    </tbody>
  </table>
</div>

<div class="shift-action-buttons">
  <% if @shift.draft? %>
    <%= link_to edit_step1_project_shift_path(@project, @shift),
                class: "btn btn-warning text-white d-flex align-items-center gap-2 px-4 py-2 shadow-sm border-0" do %>
      <i class="bi bi-person-plus-fill"></i>
      <span>スタッフ追加</span>
    <% end %>

    <%= button_to finalize_project_shift_path(@project, @shift),
                  method: :patch,
                  class: "btn btn-success d-flex align-items-center gap-2 px-4 py-2 shadow-sm border-0" do %>
      <i class="bi bi-check-circle"></i>
      <span>確定</span>
    <% end %>
  <% end %>
</div>