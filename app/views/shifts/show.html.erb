<h2><%= @shift.shift_date.strftime("%Y-%m-%d") %> のシフト</h2>

<table class="table table-bordered table-hover text-center" data-controller="shift-detail">
  <thead>
    <tr>
      <th class="bg-secondary text-white">スタッフ</th>
      <th class="bg-secondary text-white">休憩室</th>
      <th class="bg-secondary text-white comment-cell">コメント</th>
      <% (18..33).each do |h| %>
        <th class="bg-secondary text-white time-col"><%= "#{h % 24}:00" %></th>
      <% end %>
      <th class="bg-secondary text-white">編集</th>
    </tr>
  </thead>

  <tbody>
    <% grouped = @shift.shift_details.includes(:staff, :break_room)
                   .group_by { |d| d.group_id }
                   .sort_by { |g, _| g.nil? ? 1 : 0 } %>

    <% grouped.each do |group_id, details| %>
      <!-- グループ行 -->
      <tr style="background-color: white; font-weight: bold;">
        <td colspan="20"><%= Group.find_by(id: group_id)&.name || "未所属" %></td>
      </tr>

      <% details.each do |detail| %>
        <tr data-shift-detail-id="<%= detail.id %>">
          <!-- スタッフ名 -->
          <td class="text-start"><%= detail.staff.name %></td>

          <!-- 休憩室 -->
          <td>
            <%= select_tag "break_room_id",
                  options_from_collection_for_select(@break_rooms, :id, :name, detail.break_room_id),
                  data: { action: "change->shift-detail#update",
                          shift_detail_id: detail.id,
                          field: "break_room_id" } %>
          </td>

          <!-- コメント -->
          <td><%= detail.comment.presence || "-" %></td>

          <!-- 時間軸セル -->
          <% (18..33).each do |h| %>
            <% current_time = Time.zone.parse("#{detail.rest_start_time.to_date} #{h % 24}:00") %>
            <% active = (detail.rest_start_time...detail.rest_end_time).cover?(current_time) %>
            <td class="time-cell <%= 'bg-info' if active %>" data-hour="<%= h %>"></td>
          <% end %>

          <!-- 編集用セレクト -->
          <td>
            <% start_h = detail.rest_start_time.hour + (detail.rest_start_time.to_date > @shift.shift_date ? 24 : 0) %>
            <% end_h   = detail.rest_end_time.hour   + (detail.rest_end_time.to_date > @shift.shift_date ? 24 : 0) %>

            開始:
            <%= select_tag "rest_start_time",
                  options_for_select(
                    (18..33).map { |h| ["#{h % 24}:00", h] },
                    start_h
                  ),
                  data: { action: "change->shift-detail#update",
                          shift_detail_id: detail.id,
                          field: "rest_start_time" } %><br>

            終了:
            <%= select_tag "rest_end_time",
                  options_for_select(
                    (18..33).map { |h| ["#{h % 24}:00", h] },
                    end_h
                  ),
                  data: { action: "change->shift-detail#update",
                          shift_detail_id: detail.id,
                          field: "rest_end_time" } %>

            <!-- グループID hiddenで保持 -->
            <%= hidden_field_tag "group_id",
                  detail.group_id,
                  data: { shift_detail_id: detail.id, field: "group_id" } %>
          </td>
        </tr>
      <% end %>
    <% end %>
  </tbody>
</table>

<div class="mt-3 d-flex justify-content-center">
  <% if @shift.draft? %>
    <%= button_to finalize_project_shift_path(@project, @shift),
                  method: :patch,
                  class: "btn btn-success d-flex align-items-center px-4" do %>
      <i class="bi bi-check-circle me-2"></i> 完了
    <% end %>
  <% end %>
</div>