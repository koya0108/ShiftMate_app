<h2><%= @shift.shift_date.strftime("%Y-%m-%d") %></h2>
<h4>勤務スタッフ：<%= @shift.shift_details.count %>名（長日勤：<%= @shift.shift_details.where(preference: "long-shift").count %>名）</h4>

<div class="shift-action-buttons" style="justify-content: flex-start;">
  <%= link_to "カレンダーへ戻る", project_shift_top_path, class: "btn btn-success" %>
</div>

<div class="table-wrapper">
  <table class="table table-bordered table-hover text-center shift-table day-shift-table">
    <thead>
      <tr>
        <th class="bg-secondary text-white">スタッフ</th>
        <th class="bg-secondary text-white comment-cell">コメント</th>
        <th class="bg-secondary text-white">希望</th>

        <% # 横軸：11:00〜17:00を30分刻みで生成 %>
        <% times = (11 * 60...17 * 60).step(30).map { |m| m / 60.0 } %>
        <% times.each do |h| %>
          <% hour = h.floor %>
          <% minute = ((h - hour) * 60).to_i %>
          <th class="bg-secondary text-white time-col">
            <%= format("%02d:%02d", hour, minute) %>
          </th>
        <% end %>
      </tr>
    </thead>

    <tbody>
      <% grouped = @shift.shift_details.includes(:staff, :break_room)
                    .group_by { |d| d.group }
                    .sort_by { |group, _| [group.nil? ? 1 : 0, group&.created_at] } %>

      <% grouped.each do |group, details| %>
        <!-- グループ行 -->
        <%= render partial: "shifts/group_row_confirm",
                  locals: {
                    group: group,
                    times: @times,
                    group_counts: @group_counts
                  } %>

        <% details.sort_by { |d| d.staff.created_at }.each do |detail| %>
          <tr>
            <!-- スタッフ名 -->
            <td class="text-start"><%= detail.staff.name %></td>

            <!-- コメント -->
            <td><%= detail.comment.presence || "-" %></td>

            <!-- 希望 -->
            <td>
              <% case detail.preference %>
              <% when "early" %>
                  ●
              <% when "middle" %>
                  ●
              <% when "middle-late" %>
                  ●
              <% when "late" %>
                  ●
              <% when "long-shift" %>
                  長日勤
              <% else %>
                  -
              <% end %>
            </td>

            <!-- 時間軸セル -->
            <% times.each do |h| %>
              <% hour = h.floor %>
              <% minute = ((h - hour) * 60).to_i %>
              <% current_time = Time.zone.local(@shift.shift_date.year, @shift.shift_date.month, @shift.shift_date.day, hour, minute) %>
              <% active = (detail.rest_start_time...detail.rest_end_time).cover?(current_time) %>
              <td class="time-cell <%= 'bg-info' if active %>" 
                  data-hour="<%= format('%02d:%02d', hour, minute) %>"></td>
            <% end %>
          </tr>
        <% end %>
      <% end %>
    </tbody>
  </table>
</div>

<div class="shift-action-buttons">
  <%= button_to reopen_project_shift_path(@project, @shift),
                method: :patch,
                class: "btn btn-warning d-flex align-items-center px-4" do %>
    <i class="bi bi-pencil-square me-2"></i> 編集
  <% end %>

  <%= link_to confirm_project_shift_path(@project, @shift, format: :pdf),
              class: "btn btn-primary d-flex align-items-center px-4",
              target: "_blank" do %>
    <i class="bi bi-file-earmark-pdf me-2"></i> PDF出力
  <% end %>

  <%= button_to project_shift_path(@project, @shift),
                method: :delete,
                data: { "turbo-confirm": "本当に削除しますか？" },
                class: "btn btn-danger d-flex align-items-center px-4" do %>
    <i class="bi bi-trash me-2"></i> 削除
  <% end %>
</div>