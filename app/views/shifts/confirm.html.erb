<h2><%= @shift.shift_date.strftime("%Y-%m-%d") %> のシフト（確定版）</h2>
<div class="d-flex justify-content-end mb-3">
  <%= link_to "カレンダーへ戻る", project_shift_top_path, class: "btn btn-success" %>
</div>
<table class="table table-bordered table-hover text-center">
  <thead>
    <tr>
      <th class="bg-secondary text-white">スタッフ</th>
      <th class="bg-secondary text-white">休憩室</th>
      <th class="bg-secondary text-white comment-cell">コメント</th>
      <% (18..33).each do |h| %>
        <th class="bg-secondary text-white time-col"><%= "#{h % 24}:00" %></th>
      <% end %>
    </tr>
  </thead>

  <tbody>
    <% grouped = @shift.shift_details.includes(:staff, :break_room)
                   .group_by { |d| d.group_id }
                   .sort_by { |g, _| g.nil? ? 1 : 0 } %>

    <% grouped.each do |group_id, details| %>
      <!-- グループ行 -->
      <tr style="background-color: white; font-weight: bold;">
        <td colspan="19"><%= Group.find_by(id: group_id)&.name || "未所属" %></td>
      </tr>

      <% details.each do |detail| %>
        <tr>
          <!-- スタッフ名 -->
          <td class="text-start"><%= detail.staff.name %></td>

          <!-- 休憩室 -->
          <td><%= detail.break_room&.name || "-" %></td>

          <!-- コメント -->
          <td><%= detail.comment.presence || "-" %></td>

          <!-- 時間軸セル -->
          <% (18..33).each do |h| %>
            <% current_time = Time.zone.parse("#{detail.rest_start_time.to_date} #{h % 24}:00") %>
            <% if (detail.rest_start_time...detail.rest_end_time).cover?(current_time) %>
              <td class="bg-info"></td>
            <% else %>
              <td></td>
            <% end %>
          <% end %>
        </tr>
      <% end %>
    <% end %>
  </tbody>
</table>

<div class="mt-4 d-flex justify-content-center gap-3">
  <%= button_to reopen_project_shift_path(@project, @shift),
                method: :patch,
                class: "btn btn-warning d-flex align-items-center px-4" do %>
    <i class="bi bi-pencil-square me-2"></i> 編集
  <% end %>

  <%= button_to "#",
                class: "btn btn-primary d-flex align-items-center px-4" do %>
    <i class="bi bi-printer me-2"></i> 印刷
  <% end %>

  <%= button_to project_shift_path(@project, @shift),
              method: :delete,
              data: { "turbo-confirm": "本当に削除しますか？" },
              class: "btn btn-danger" do %>
  <i class="bi bi-trash me-2"></i> 削除
  <% end %>
</div>